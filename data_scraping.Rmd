---
title: "data_scraping"
author: "Luke Kolar"
date: "2/21/2020"
output: html_document
---

I retrieved my data from [Genius](https://genius.com/), [whosampled.com](https://whosampled.com) and [Discogs](discogs.com). The former was easy, as there are packages that make scraping simple, but the latter two were / are more difficult...

The difficulty of [whosampled.com](https://whosampled.com) comes from both the fact that it's not coder-friendly (it doesn't have an API key system, like the other two), and that its website is inconsistent. I wrote several functions to scrape the website using CSS selectors, and these functions had to include dozens of if / else statements because website URLs weren't always the same format for different sub-pages, etc. For instance, a song's samples are only listen on a separate page if there are more than 5. Also, not every song has a listed genre, and CSS selectors aren't linked to each other, so I decided to run the song titles / artists I found on whosampled through another music database...

[Discogs](discogs.com) is the largest Internet database, and I was able to find a simple package to replicate its search function. The search function prints a "discogs dataframe," which is super strange to work with. So far, I've been able to extract genres and styles for songs through it, since it's partly in list format. However, I'm still working on a method to do this for every song, and I'm looking into how I can have the code recognize when a song isn't in the Discogs database (because it simple prints a blank "discogs dataframe). 

Overall, I've made a lot of progress, and I'm very proud of it. There's still much work to do, but I'm confident that I'm working through it at a pace that will allow me to create an awesome shiny app, much like those of my inspiration for the project, [David Smale](https://davidsmale.netlify.com/portfolio/).

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, message = F, include = F}
# Initial library loading

library(usethis)      # for setting API keys
library(knitr)
library(janitor)      # cleaning data
library(tidytext)     # helpful with 'geniusr' package
library(textdata)       # same as above
library(stringr)      # modifying character values
library(rvest)
library(shiny)
library(raster)
library(spDataLarge)
library(spData)
library(rgeos)
library(rnaturalearth)
library(rnaturalearthdata)
library(sf)
library(tidyverse)

```

```{r, include = F}
# 'Genius'-specific packages
library(geniusr)
Sys.setenv(GENIUS_API_TOKEN = 'A629GZJinyQQJN11vDjRf_3tjx6Dsw5fpH1hdiLZwhpgABHw4yyTpm6nFQj592p8')
genius_token()

# 'Discogs'-specific packages
library(discogger)
Sys.setenv(DISCOGS_API_TOKEN = 'UqigHPcLrZSSnZuebGkYFAMdYWBWRzvtfHsgtkZK')
discogs_api_token()

# 'Spotify'-specific packages
library(spotifyr)
Sys.setenv(SPOTIFY_CLIENT_ID = '9ffd8734c372455faf4f66524809478d')
Sys.setenv(SPOTIFY_CLIENT_SECRET = 'f7d542ebdfa14c318ef9208b877ecd61')
get_spotify_access_token()
```

```{r, message = F, echo = F, include = T}
# set lexicon
bing <- get_sentiments("bing")

# scrape album tracklist
tracklist <- get_album_tracklist_search(artist_name = "Daft Punk",
                                        album_name = "Discovery")

tracklist <- tracklist[c(1, 3:4, 7, 9, 13:14),]

# scrape album lyrics
lyrics <- map_df(tracklist$song_lyrics_url, get_lyrics_url)

# counting negative / positive words
sentiment <- lyrics %>%
  unnest_tokens(word, line) %>%
  # remove stop words
  anti_join(stop_words, by = "word") %>%
  # join afinn score
  inner_join(bing, by = "word") %>%
  # count negative / positive words
  count(word, sentiment, sort = TRUE) %>%
  ungroup()

# plotting top contributors
sentiment %>%
  group_by(sentiment) %>%
  top_n(10) %>%
  ungroup() %>%
  mutate(word = reorder(word, n)) %>%
  ggplot(aes(word, n, fill = sentiment)) +
  geom_col(show.legend = FALSE) +
  facet_wrap(~sentiment, scales = "free_y") +
  labs(y = "Discovery: Words that contribute the most to positive and negative sentiment",
       x = NULL) +
  coord_flip() +
  theme_minimal()

```

```{r, echo = F, include = F}
# [B] Storing values...

# lyric vectors:

One_More_Time.lyrics <- get_lyrics_search(artist_name = "Daft Punk",
                  song_title = "One More Time")
Aerodynamic.lyrics <- get_lyrics_search(artist_name = "Daft Punk",
                  song_title = "Aerodynamic")
Digital_Love.lyrics <- get_lyrics_search(artist_name = "Daft Punk",
                  song_title = "Digital Love")
H_B_F_S.lyrics <- get_lyrics_search(artist_name = "Daft Punk",
                  song_title = "Harder, Better, Faster, Stronger")
Crescendolls.lyrics <- get_lyrics_search(artist_name = "Daft Punk",
                  song_title = "Crescendolls")
Nightvision.lyrics <- get_lyrics_search(artist_name = "Daft Punk",
                  song_title = "Nightvision")
Superheroes.lyrics <- get_lyrics_search(artist_name = "Daft Punk",
                  song_title = "Superheroes")
High_Life.lyrics <- get_lyrics_search(artist_name = "Daft Punk",
                  song_title = "High Life")
Something_About_Us.lyrics <- get_lyrics_search(artist_name = "Daft Punk",
                  song_title = "Something About Us")
Voyager.lyrics <- get_lyrics_search(artist_name = "Daft Punk",
                  song_title = "Voyager")
Veridis_Quo.lyrics <- get_lyrics_search(artist_name = "Daft Punk",
                  song_title = "Veridis Quo")


# All songs, for use later...

tracklist <- c("One More Time", "Aerodynamic", "Digital Love",
               "Harder, Better, Faster, Stronger", "Crescendolls",
               "Nightvision", "Superheroes", "High Life", 
               "Something About Us", "Voyager", "Veridis Quo",
               "Short Circuit", "Face to Face", "Too Long")
samples.tab <- tibble(tracks = as.vector(tracklist))

# section header values (for functions in [C]):

samps.txt <- "Contains samples of"
sampd.txt <- "Was sampled in"
cov.txt <- "Was covered in"
rem.txt <- "Was remixed in"

```


```{r, echo = F, include = F} 
# [C]: Functions...

shnum.rename <- function(shnum, sh1, sh2, sh3, sh4){
  if(shnum == 4){
    sh.samps <- sh1
    sh.sampd <- sh2
    sh.cov <- sh3
    sh.rem <- sh4
  }else{
    if(shnum == 3){
      if(startsWith(sh1, samps.txt)){
          sh.samps <- sh1
          if(startsWith(sh2, sampd.txt)){
            sh.sampd <- sh2
            if(startsWith(sh3, cov.txt)){
              sh.cov <- sh3
              sh.rem <- NA
            }else{
              sh.cov <- NA
              sh.rem <- sh3
            }
          }else{
            sh.sampd <- NA
            sh.cov <- sh2
            sh.rem <- sh3
          }
        }else{
          sh.samps <- NA
          sh.sampd <- sh1
          sh.cov <- sh2
          sh.rem <- sh3
        }
    }else{
      if(shnum == 2){
        if(startsWith(sh1, samps.txt)){
            sh.samps <- sh1
            if(startsWith(sh2, sampd.txt)){
              sh.sampd <- sh2
              sh.cov <- NA
              sh.rem <- NA
            }else{
              if(startsWith(sh2, cov.txt)){
                sh.sampd <- NA
                sh.cov <- sh2
                sh.rem <- NA
              }else{
                sh.sampd <- NA
                sh.cov <- NA
                sh.rem <- sh2
              }
            }
          }else{
            if(startsWith(sh1, sampd.txt)){
              sh.samps <- NA
              sh.sampd <- sh1
              if(startsWith(sh2, cov.txt)){
                sh.cov <- sh2
                sh.rem <- NA
              }else{
                sh.cov <- NA
                sh.rem <- sh2
              }
            }else{
              sh.samps <- NA
              sh.sampd <- NA
              sh.cov <- sh1
              sh.rem <- sh2
            }
          }
      }else{
        if(shnum == 1){
          if(startsWith(sh1, samps.txt)){
                sh.samps <- sh1
                sh.sampd <- NA
                sh.cov <- NA
                sh.rem <- NA
              }else{
                if(startsWith(sh1, sampd.txt)){
                  sh.samps <- NA
                  sh.sampd <- sh1
                  sh.cov <- NA
                  sh.rem <- NA
                }else{
                  if(startsWith(sh1, cov.txt)){
                    sh.samps <- NA
                    sh.sampd <- NA
                    sh.cov <- sh1
                    sh.rem <- NA
                  }else{
                    sh.samps <- NA
                    sh.sampd <- NA
                    sh.cov <- NA
                    sh.rem <- sh1
                  }
                }  
              }
        }else{
            sh.samps <- NA
            sh.sampd <- NA
            sh.cov <- NA
            sh.rem <- NA
        }
      }
    }
  }
  sh.vect <- as.vector(c(sh.samps, sh.sampd, sh.cov, sh.rem))
  sh.vect
}

all.sh <- function(url){
  headers <- html_text(html_nodes(read_html(url),'.section-header-title'))
  l <- length(headers)
  if(l == 0){
    shnum <- 0
    sh1 <- "No samples"
  }else{
    if(l == 1){
      shnum <- 1
      sh1 <- headers[[1]]
      sh2 <- NA
      sh3 <- NA
      sh4 <- NA
    }else{
      if(l == 2){
        shnum <- 2
        sh1 <- headers[[1]]
        sh2 <- headers[[2]]
        sh3 <- NA
        sh4 <- NA
      }else{
        if(l == 3){
          shnum <- 3
          sh1 <- headers[[1]]
          sh2 <- headers[[2]]
          sh3 <- headers[[3]]
          sh4 <- NA
        }else{
          shnum <- 4
          sh1 <- headers[[1]]
          sh2 <- headers[[2]]
          sh3 <- headers[[3]]
          sh4 <- headers[[4]]
        }
      }
    }
  }
  shnum.rename(shnum, sh1 = sh1, sh2 = sh2, sh3 = sh3, sh4 = sh4)
}

numextract <- function(string){ 
  str_extract(string, "\\-*\\d+\\.*\\d*")
}

samp.tibble <- function(artist, song){
  url <- paste0("https://www.whosampled.com/", gsub(" ", "-", artist, fixed = T),"/", 
                gsub(" ", "-", song, fixed = T), "/")
  samp.vect <- all.sh(url)
  samp.tibble <- tibble(type = c("Samples", "Sampled", "Covers", "Remixes"),
                        number = as.numeric(numextract(samp.vect)))
  samp.tibble
}

get.samps <- function(artist, song){
  samp.tib <- samp.tibble(artist, song)
  samp.tib <- samp.tib %>% replace_na(list(number = 0))
  url <- paste0("https://www.whosampled.com/", gsub(" ", "-", artist, fixed = T),"/", 
                gsub(" ", "-", song, fixed = T))
  if(pull(samp.tib[1, 2]) == 0){
    samps <- NA
  }else{ 
    if(pull(samp.tib[1, 2]) <= 5){
      n1 <- pull(samp.tib[1, 2])
      samps <- tibble(track = as.vector(html_text(html_nodes(read_html(url),'.playIcon')))[1:n1], 
                      artist = as.vector(html_text(html_nodes(read_html(url),'.trackArtist')))[1:n1])
    }else{
      if(ceiling(pull(samp.tib[1, 2]) / 16) == 1){
        url1 <- paste0(url, "/samples/", "?cp=", "1")
        samps <- tibble(track = as.vector(html_text(html_nodes(read_html(url1),'.playIcon'))), 
                        artist = as.vector(html_text(html_nodes(read_html(url1),'.trackArtist'))))
      }else{
        if(ceiling(pull(samp.tib[1, 2]) / 16) == 2){
          url1 <- paste0(url, "/samples/", "?cp=", "1")
          samps <- tibble(track = as.vector(html_text(html_nodes(read_html(url1),'.playIcon'))), 
                          artist = as.vector(html_text(html_nodes(read_html(url1),'.trackArtist'))))
          url2 <- paste0(url, "/samples/", "?cp=", "2")
          samps <- add_row(samps, track = as.vector(html_text(html_nodes(read_html(url2),'.playIcon'))),
                          artist = as.vector(html_text(html_nodes(read_html(url2),'.trackArtist'))))
        }else{
          if(ceiling(pull(samp.tib[1, 2]) / 16) == 3){
            url1 <- paste0(url, "/samples/", "?cp=", "1")
            samps <- tibble(track = as.vector(html_text(html_nodes(read_html(url1),'.playIcon'))), 
                            artist = as.vector(html_text(html_nodes(read_html(url1),'.trackArtist'))))  
            url2 <- paste0(url, "/samples/", "?cp=", "2")
            samps <- add_row(samps, track = as.vector(html_text(html_nodes(read_html(url2),'.playIcon'))),
                            artist = as.vector(html_text(html_nodes(read_html(url2),'.trackArtist'))))
            url3 <- paste0(url, "/samples/", "?cp=", "3")
            samps <- add_row(samps, track = as.vector(html_text(html_nodes(read_html(url3),'.playIcon'))),
                            artist = as.vector(html_text(html_nodes(read_html(url3),'.trackArtist'))))
          }else{
            if(ceiling(pull(samp.tib[1, 2]) / 16) == 4){
              url1 <- paste0(url, "/samples/", "?cp=", "1")
              samps <- tibble(track = as.vector(html_text(html_nodes(read_html(url1),'.playIcon'))), 
                              artist = as.vector(html_text(html_nodes(read_html(url1),'.trackArtist'))))
              url2 <- paste0(url, "/samples/", "?cp=", "2")
              samps <- add_row(samps, track = as.vector(html_text(html_nodes(read_html(url2),'.playIcon'))),
                              artist = as.vector(html_text(html_nodes(read_html(url2),'.trackArtist'))))
              url3 <- paste0(url, "/samples/", "?cp=", "3")
              samps <- add_row(samps, track = as.vector(html_text(html_nodes(read_html(url3),'.playIcon'))),
                              artist = as.vector(html_text(html_nodes(read_html(url3),'.trackArtist'))))
              url4 <- paste0(url, "/samples/", "?cp=", "4")
              samps <- add_row(samps, track = as.vector(html_text(html_nodes(read_html(url4),'.playIcon'))),
                              artist = as.vector(html_text(html_nodes(read_html(url4),'.trackArtist'))))
            }else{
              print("more than 4 pages...")
            }
          }
        }
      }
    }
  }
  if(!is.tibble(samps)){
    samps
  }else{
    samps <- samps %>%
      mutate(artist = gsub("\n\t\t\t", "", artist, fixed = T),
             artist = sub("by ", "", artist, fixed = T),
             year = str_sub(artist,-6,-1),
             year = as.numeric(str_sub(year, 2, 5)),
             artist = str_sub(artist, 0, nchar(artist) - 7)) %>% 
      mutate(artist = gsub("feat.*","",artist)) %>% 
      mutate(type = "samples")
    samps
  }
}

get.sampd <- function(artist, song){
  samp.tib <- samp.tibble(artist, song)
  samp.tib <- samp.tib %>% replace_na(list(number = 0))
  url <- paste0("https://www.whosampled.com/", gsub(" ", "-", artist, fixed = T),"/", 
                gsub(" ", "-", song, fixed = T))
  if(pull(samp.tib[2, 2]) == 0){
    sampd <- NA
  }else{ 
    if(pull(samp.tib[2, 2]) <= 5){
      n1 <- ifelse(pull(samp.tib[1, 2]) >= 5, 6, pull(samp.tib[1, 2]) + 1)
      n2 <- n1 + pull(samp.tib[2, 2]) - 1
      sampd <- tibble(track = as.vector(html_text(html_nodes(read_html(url),'.playIcon')))[n1:n2], 
                      artist = as.vector(html_text(html_nodes(read_html(url),'.trackArtist')))[n1:n2])
    }else{
      if(ceiling(pull(samp.tib[2, 2]) / 16) == 1){
        url1 <- paste0(url, "/sampled/", "?cp=", "1")
        sampd <- tibble(track = as.vector(html_text(html_nodes(read_html(url1),'.playIcon'))), 
                        artist = as.vector(html_text(html_nodes(read_html(url1),'.trackArtist'))))
      }else{
        if(ceiling(pull(samp.tib[2, 2]) / 16) == 2){
          url1 <- paste0(url, "/sampled/", "?cp=", "1")
          sampd <- tibble(track = as.vector(html_text(html_nodes(read_html(url1),'.playIcon'))), 
                          artist = as.vector(html_text(html_nodes(read_html(url1),'.trackArtist'))))
          url2 <- paste0(url, "/sampled/", "?cp=", "2")
          sampd <- add_row(sampd, track = as.vector(html_text(html_nodes(read_html(url2),'.playIcon'))),
                          artist = as.vector(html_text(html_nodes(read_html(url2),'.trackArtist'))))
        }else{
          if(ceiling(pull(samp.tib[2, 2]) / 16) == 3){
            url1 <- paste0(url, "/sampled/", "?cp=", "1")
            sampd <- tibble(track = as.vector(html_text(html_nodes(read_html(url1),'.playIcon'))), 
                            artist = as.vector(html_text(html_nodes(read_html(url1),'.trackArtist'))))  
            url2 <- paste0(url, "/sampled/", "?cp=", "2")
            sampd <- add_row(sampd, track = as.vector(html_text(html_nodes(read_html(url2),'.playIcon'))),
                            artist = as.vector(html_text(html_nodes(read_html(url2),'.trackArtist'))))
            url3 <- paste0(url, "/sampled/", "?cp=", "3")
            sampd <- add_row(sampd, track = as.vector(html_text(html_nodes(read_html(url3),'.playIcon'))),
                            artist = as.vector(html_text(html_nodes(read_html(url3),'.trackArtist'))))
          }else{
            if(ceiling(pull(samp.tib[2, 2]) / 16) == 4){
              url1 <- paste0(url, "/sampled/", "?cp=", "1")
              sampd <- tibble(track = as.vector(html_text(html_nodes(read_html(url1),'.playIcon'))), 
                              artist = as.vector(html_text(html_nodes(read_html(url1),'.trackArtist'))))
              url2 <- paste0(url, "/sampled/", "?cp=", "2")
              sampd <- add_row(sampd, track = as.vector(html_text(html_nodes(read_html(url2),'.playIcon'))),
                              artist = as.vector(html_text(html_nodes(read_html(url2),'.trackArtist'))))
              url3 <- paste0(url, "/sampled/", "?cp=", "3")
              sampd <- add_row(sampd, track = as.vector(html_text(html_nodes(read_html(url3),'.playIcon'))),
                              artist = as.vector(html_text(html_nodes(read_html(url3),'.trackArtist'))))
              url4 <- paste0(url, "/sampled/", "?cp=", "4")
              sampd <- add_row(sampd, track = as.vector(html_text(html_nodes(read_html(url4),'.playIcon'))),
                              artist = as.vector(html_text(html_nodes(read_html(url4),'.trackArtist'))))
            }else{
              print("more than 4 pages...")
            }
          }
        }
      }
    }
  }
  if(!is.tibble(sampd)){
    sampd
  }else{
    sampd <- sampd %>%
      mutate(artist = gsub("\n\t\t\t", "", artist, fixed = T),
             artist = sub("by ", "", artist, fixed = T),
             year = str_sub(artist,-6,-1),
             year = as.numeric(str_sub(year, 2, 5)),
             artist = str_sub(artist, 0, nchar(artist) - 7)) %>% 
      mutate(artist = gsub("feat.*","",artist)) %>% 
      mutate(type = "sampled")
    sampd
  }
}

get.cov <- function(artist, song){
  samp.tib <- samp.tibble(artist, song)
  samp.tib <- samp.tib %>% replace_na(list(number = 0))
  url <- paste0("https://www.whosampled.com/", gsub(" ", "-", artist, fixed = T),"/", 
                gsub(" ", "-", song, fixed = T))
  if(pull(samp.tib[3, 2]) == 0){
    cov <- NA
  }else{ 
    if(pull(samp.tib[3, 2]) <= 5){
      n1 <- ifelse(pull(samp.tib[1, 2]) >= 5, 5, pull(samp.tib[1, 2])) + 
            ifelse(pull(samp.tib[2, 2]) >= 5, 6, pull(samp.tib[2, 2]) + 1)
      n2 <- n1 + pull(samp.tib[3, 2]) - 1
      cov <- tibble(track = as.vector(html_text(html_nodes(read_html(url),'.playIcon')))[n1:n2], 
                      artist = as.vector(html_text(html_nodes(read_html(url),'.trackArtist')))[n1:n2])
    }else{
      if(ceiling(pull(samp.tib[3, 2]) / 16) == 1){
        url1 <- paste0(url, "/covered/", "?cp=", "1")
        cov <- tibble(track = as.vector(html_text(html_nodes(read_html(url1),'.playIcon'))), 
                        artist = as.vector(html_text(html_nodes(read_html(url1),'.trackArtist'))))
      }else{
        if(ceiling(pull(samp.tib[3, 2]) / 16) == 2){
          url1 <- paste0(url, "/covered/", "?cp=", "1")
          cov <- tibble(track = as.vector(html_text(html_nodes(read_html(url1),'.playIcon'))), 
                          artist = as.vector(html_text(html_nodes(read_html(url1),'.trackArtist'))))
          url2 <- paste0(url, "/covered/", "?cp=", "2")
          cov <- add_row(cov, track = as.vector(html_text(html_nodes(read_html(url2),'.playIcon'))),
                          artist = as.vector(html_text(html_nodes(read_html(url2),'.trackArtist'))))
        }else{
          if(ceiling(pull(samp.tib[3, 2]) / 16) == 3){
            url1 <- paste0(url, "/covered/", "?cp=", "1")
            cov <- tibble(track = as.vector(html_text(html_nodes(read_html(url1),'.playIcon'))), 
                            artist = as.vector(html_text(html_nodes(read_html(url1),'.trackArtist'))))  
            url2 <- paste0(url, "/covered/", "?cp=", "2")
            cov <- add_row(cov, track = as.vector(html_text(html_nodes(read_html(url2),'.playIcon'))),
                            artist = as.vector(html_text(html_nodes(read_html(url2),'.trackArtist'))))
            url3 <- paste0(url, "/covered/", "?cp=", "3")
            cov <- add_row(cov, track = as.vector(html_text(html_nodes(read_html(url3),'.playIcon'))),
                            artist = as.vector(html_text(html_nodes(read_html(url3),'.trackArtist'))))
          }else{
            if(ceiling(pull(samp.tib[3, 2]) / 16) == 4){
              url1 <- paste0(url, "/covered/", "?cp=", "1")
              cov <- tibble(track = as.vector(html_text(html_nodes(read_html(url1),'.playIcon'))), 
                              artist = as.vector(html_text(html_nodes(read_html(url1),'.trackArtist'))))
              url2 <- paste0(url, "/covered/", "?cp=", "2")
              cov <- add_row(cov, track = as.vector(html_text(html_nodes(read_html(url2),'.playIcon'))),
                              artist = as.vector(html_text(html_nodes(read_html(url2),'.trackArtist'))))
              url3 <- paste0(url, "/covered/", "?cp=", "3")
              cov <- add_row(cov, track = as.vector(html_text(html_nodes(read_html(url3),'.playIcon'))),
                              artist = as.vector(html_text(html_nodes(read_html(url3),'.trackArtist'))))
              url4 <- paste0(url, "/covered/", "?cp=", "4")
              cov <- add_row(cov, track = as.vector(html_text(html_nodes(read_html(url4),'.playIcon'))),
                              artist = as.vector(html_text(html_nodes(read_html(url4),'.trackArtist'))))
            }else{
              print("more than 4 pages...")
            }
          }
        }
      }
    }
  }
  if(!is.tibble(cov)){
    cov
  }else{
    cov <- cov %>%
      mutate(artist = gsub("\n\t\t\t", "", artist, fixed = T),
             artist = sub("by ", "", artist, fixed = T),
             year = str_sub(artist,-6,-1),
             year = as.numeric(str_sub(year, 2, 5)),
             artist = str_sub(artist, 0, nchar(artist) - 7)) %>% 
      mutate(artist = gsub("feat.*","",artist)) %>% 
      mutate(type = "cover")
    cov
  }
}

get.rem <- function(artist, song){
  samp.tib <- samp.tibble(artist, song)
  samp.tib <- samp.tib %>% replace_na(list(number = 0))
  url <- paste0("https://www.whosampled.com/", gsub(" ", "-", artist, fixed = T),"/", 
                gsub(" ", "-", song, fixed = T))
  if(pull(samp.tib[4, 2]) == 0){
    rem <- NA
  }else{ 
    if(pull(samp.tib[4, 2]) <= 5){
      n1 <- ifelse(pull(samp.tib[1, 2]) >= 5, 5, pull(samp.tib[1, 2])) + 
            ifelse(pull(samp.tib[2, 2]) >= 5, 5, pull(samp.tib[2, 2])) +
            ifelse(pull(samp.tib[3, 2]) >= 5, 6, pull(samp.tib[3, 2]) + 1)
      n2 <- n1 + pull(samp.tib[4, 2]) - 1
      rem <- tibble(track = as.vector(html_text(html_nodes(read_html(url),'.playIcon')))[n1:n2], 
                      artist = as.vector(html_text(html_nodes(read_html(url),'.trackArtist')))[n1:n2])
    }else{
      if(ceiling(pull(samp.tib[4, 2]) / 16) == 1){
        url1 <- paste0(url, "/remixed/", "?cp=", "1")
        rem <- tibble(track = as.vector(html_text(html_nodes(read_html(url1),'.playIcon'))), 
                        artist = as.vector(html_text(html_nodes(read_html(url1),'.trackArtist'))))
      }else{
        if(ceiling(pull(samp.tib[4, 2]) / 16) == 2){
          url1 <- paste0(url, "/remixed/", "?cp=", "1")
          rem <- tibble(track = as.vector(html_text(html_nodes(read_html(url1),'.playIcon'))), 
                          artist = as.vector(html_text(html_nodes(read_html(url1),'.trackArtist'))))
          url2 <- paste0(url, "/remixed/", "?cp=", "2")
          rem <- add_row(rem, track = as.vector(html_text(html_nodes(read_html(url2),'.playIcon'))),
                          artist = as.vector(html_text(html_nodes(read_html(url2),'.trackArtist'))))
        }else{
          if(ceiling(pull(samp.tib[4, 2]) / 16) == 3){
            url1 <- paste0(url, "/remixed/", "?cp=", "1")
            rem <- tibble(track = as.vector(html_text(html_nodes(read_html(url1),'.playIcon'))), 
                            artist = as.vector(html_text(html_nodes(read_html(url1),'.trackArtist'))))  
            url2 <- paste0(url, "/remixed/", "?cp=", "2")
            rem <- add_row(rem, track = as.vector(html_text(html_nodes(read_html(url2),'.playIcon'))),
                            artist = as.vector(html_text(html_nodes(read_html(url2),'.trackArtist'))))
            url3 <- paste0(url, "/remixed/", "?cp=", "3")
            rem <- add_row(rem, track = as.vector(html_text(html_nodes(read_html(url3),'.playIcon'))),
                            artist = as.vector(html_text(html_nodes(read_html(url3),'.trackArtist'))))
          }else{
            if(ceiling(pull(samp.tib[4, 2]) / 16) == 4){
              url1 <- paste0(url, "/remixed/", "?cp=", "1")
              rem <- tibble(track = as.vector(html_text(html_nodes(read_html(url1),'.playIcon'))), 
                              artist = as.vector(html_text(html_nodes(read_html(url1),'.trackArtist'))))
              url2 <- paste0(url, "/remixed/", "?cp=", "2")
              rem <- add_row(rem, track = as.vector(html_text(html_nodes(read_html(url2),'.playIcon'))),
                              artist = as.vector(html_text(html_nodes(read_html(url2),'.trackArtist'))))
              url3 <- paste0(url, "/remixed/", "?cp=", "3")
              rem <- add_row(rem, track = as.vector(html_text(html_nodes(read_html(url3),'.playIcon'))),
                              artist = as.vector(html_text(html_nodes(read_html(url3),'.trackArtist'))))
              url4 <- paste0(url, "/remixed/", "?cp=", "4")
              rem <- add_row(rem, track = as.vector(html_text(html_nodes(read_html(url4),'.playIcon'))),
                              artist = as.vector(html_text(html_nodes(read_html(url4),'.trackArtist'))))
            }else{
              print("more than 4 pages...")
            }
          }
        }
      }
    }
  }
  if(!is.tibble(rem)){
    rem
  }else{
    rem <- rem %>%
      mutate(artist = gsub("\n\t\t\t", "", artist, fixed = T),
             artist = sub("by ", "", artist, fixed = T),
             year = str_sub(artist,-6,-1),
             year = as.numeric(str_sub(year, 2, 5)),
             artist = str_sub(artist, 0, nchar(artist) - 7))  %>% 
      mutate(artist = gsub("feat.*","",artist)) %>% 
      mutate(type = "remix")
    rem
  }
}

all.rel <- function(artist, song){
  s1 <- get.samps(artist, song) 
  s2 <- get.sampd(artist, song)
  s3 <- get.cov(artist, song)
  s4 <- get.rem(artist, song)

  all.tib <- tibble(track = c("filler"), artist = c("filler"), year = c("filler"), type = c("filler")) 
  all.tib <- if(is.tibble(s1)){rbind(all.tib, s1)}else{all.tib}
  all.tib <- if(is.tibble(s2)){rbind(all.tib, s2)}else{all.tib}
  all.tib <- if(is.tibble(s3)){rbind(all.tib, s3)}else{all.tib}
  all.tib <- if(is.tibble(s4)){rbind(all.tib, s4)}else{all.tib}
  
  all.tib %>% filter(!track == "filler")
    
}

is.discogs.error <- function(x){
  tryCatch({x},
           warning = function(w){FALSE},
           error = function(e){TRUE},
           finally = 
           ) 
}

discogs_info.tib <- function(artist, song){
  result <- 
    ifelse(!is.list(is.discogs.error(discogs_search(list(track = song, artist = artist), n_results = 1))),
           ifelse(!is.list(is.discogs.error(discogs_search(list(track = song), n_results = 1))), 
                  NA, discogs_search(list(track = song), n_results = 1)),  
           ifelse(length(discogs_search(list(track = song, artist = artist), n_results = 1)[[1]]) > 0,
                  discogs_search(list(track = song, artist = artist), n_results = 1),
           ifelse(length(discogs_search(list(track = song, artist = gsub("and.*","",artist)), n_results = 1)[[1]]) > 0,
                  discogs_search(list(track = song, artist = gsub("and.*","",artist)), n_results = 1),
                  NA)))
  tibble(song = song,
         artist = artist,
         style = ifelse(is.na(result), NA, result[[1]]$style),
         country = ifelse(is.na(result), NA, unlist(result[[1]]$country)),
         genre = ifelse(is.na(result), NA, result[[1]]$genre))
}

all.rel.album.info <- function(artist, album){
  tracklist <- get_album_tracklist_search(artist_name = artist,
                                          album_name = album) %>% 
               select(song_number, song_title) %>% 
               rename(track.num = song_number,
                      song = song_title) %>% 
               mutate(main.artist = artist)
  
  all.rel.album.info.tib <- map2_dfr(as.vector(tracklist$main.artist), 
                                     as.vector(tracklist$song),
                                     ~all.rel.song.info(artist = .x,
                                                        song = .y))
  all.rel.album.info.tib
}  

all.rel.song.info <- function(artist, song){
  all.rell.song <- all.rel(artist, song) %>% mutate(main.song = song)
  types.col <- all.rell.song %>% select(type)
  
  all.rel.song.info.tib <- map2_dfr(as.vector(all.rell.song$artist), 
                                    as.vector(all.rell.song$track), ~discogs_info.tib(artist = .x, 
                                                                                      song = .y)) %>% 
                           cbind(types.col) %>% 
                           mutate(main.song = all.rell.song$main.song)
  all.rel.song.info.tib
}

```

```{r, include = F}
# Example of whosampled and Discogs functions I've written:

artist <- "Daft Punk"
song <- "One More Time"

x <- get.samps(artist, song)
x

info <- discogs_info.tib(pull(x[1,2]), pull(x[1,1]))
info

genres <- unlist(info$genre)
genres

```

```{r, eval = F}
# This is essentially how I collected the data I've been using

all.rel.album.info(artist = "Daft Punk", album = "Discovery") %>% 
  saveRDS(file = "discogs_samp_data.RDS")

```

```{r}

data.main <- readRDS("discogs_samp_data.RDS")
View(data.main)

data.main.countries <- data.main %>% 
  filter(!is.na(country),
         !country == "Unknown",
         !type == "samples") %>%
  select(country, main.song) %>% 
  mutate(country = replace(country, country == "France & Benelux", "France")) %>%
  mutate(country = replace(country, country == "UK & Europe", "UK")) %>% 
  mutate(country = gsub("& ","", country)) %>% 
  mutate(country = as.list(strsplit(country, ", "))) %>% 
  mutate(country = replace(country, country == "US", "United States"),
         country = replace(country, country == "UK", "United Kingdom")) %>% 
  unnest(country) %>% 
  group_by(country) %>% 
  summarize(num.used = n()) %>% 
  arrange(desc(num.used))

ggplot(data.main.countries, aes(x = country, y = num.used)) + geom_col() +   
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

```

```{r}

View(world)

world.samps <- world %>% 
  rename(country = name_long) %>% 
  select(country, geom, continent) %>% 
  filter(!country == "Antarctica",
         !country == "Russian Federation",
         continent == "Europe")
music.used.mapped <- world.samps %>% 
  left_join(data.main.countries, by = c("country")) %>% 
  mutate(num.used = replace(num.used, is.na(num.used), 0))
View(music.used.mapped)

europe.plot <- ggplot(music.used.mapped, aes(fill = num.used)) + geom_sf() + 
  scale_fill_gradient(low = "aliceblue", high = "red", name = "Number of \ncredits") + 
  xlim(-23, 43) + ylim(32, 73) + theme_minimal() +
  labs(title = "The Spread of Daft Punk in Europe",
       subtitle = "Where European artists have sampled, \nremixed, or covered 'Discovery'",
       caption = "Source: WhoSampled, Genius, Discogs") +
  theme(text = element_text(family = "Courier"),
        plot.title = element_text(hjust = 0.5, size = 12, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5, size = 8),
        plot.caption = element_text(size = 7, face = "italic"),
        legend.title = element_text(size = 9)
        )
europe.plot

```



```{r}

library(spotifyr)

Sys.setenv(SPOTIFY_CLIENT_ID = '9ffd8734c372455faf4f66524809478d')
Sys.setenv(SPOTIFY_CLIENT_SECRET = 'f7d542ebdfa14c318ef9208b877ecd61')

access_token <- get_spotify_access_token()

daft <- get_artist_audio_features('Daft Punk')

daft %>% 
  filter(album_name == "Discovery") %>% View()

```


